#!/bin/bash

PLUGIN_DIR="$CONFIG_DIR/plugins"
source "$CONFIG_DIR/colors.sh"

# ===== Bar Appearance =====
# Fully transparent bar — each item renders its own background
sketchybar --bar \
  position=top \
  height=40 \
  blur_radius=0 \
  color=$BAR_COLOR \
  border_width=0 \
  shadow=off \
  padding_left=8 \
  padding_right=8 \
  margin=0 \
  y_offset=4 \
  corner_radius=0 \
  topmost=window

# ===== Defaults =====
# Every item gets a semi-transparent pill with subtle border
default=(
  padding_left=3
  padding_right=3
  icon.font="Hack Nerd Font:Bold:14.0"
  label.font="Hack Nerd Font:Bold:12.0"
  icon.color=$ICON_COLOR
  label.color=$LABEL_COLOR
  icon.padding_left=14
  icon.padding_right=4
  label.padding_left=4
  label.padding_right=14
  background.drawing=on
  background.color=$ITEM_BG
  background.border_color=$ITEM_BORDER
  background.border_width=1
  background.corner_radius=$ITEM_CORNER_RADIUS
  background.height=28
)
sketchybar --default "${default[@]}"

# ===== Apple Logo (Left) =====
# sketchybar --add item apple_logo left \
#   --set apple_logo \
#     icon="" \
#     icon.font="Hack Nerd Font:Bold:16.0" \
#     icon.color=$WHITE \
#     icon.padding_left=8 \
#     icon.padding_right=8 \
#     label.drawing=off \
#     background.drawing=on \
#     background.color=$ITEM_BG \
#     background.border_color=$ITEM_BORDER \
#     background.border_width=1 \
#     background.corner_radius=$ITEM_CORNER_RADIUS \
#     background.height=28

# ===== Aerospace Workspaces (Left) =====
sketchybar --add event aerospace_workspace_change

for sid in 1 2 3 4 5 6 7; do
  sketchybar --add item space.$sid left \
    --set space.$sid \
      icon="$sid" \
      icon.font="Hack Nerd Font:Bold:14.0" \
      icon.color=$WS_EMPTY_TEXT \
      icon.padding_left=10 \
      icon.padding_right=4 \
      label="" \
      label.font="Hack Nerd Font:Regular:12.0" \
      label.color=$WS_OCCUPIED_TEXT \
      label.padding_left=0 \
      label.padding_right=10 \
      background.drawing=on \
      background.color=$ITEM_BG \
      background.border_color=$WS_INACTIVE_BORDER \
      background.border_width=1 \
      background.corner_radius=$ITEM_CORNER_RADIUS \
      background.height=28 \
      drawing=on \
      click_script="aerospace workspace $sid"
done

# Trigger: listens for aerospace events and updates all workspaces
sketchybar --add item aerospace_trigger left \
  --set aerospace_trigger \
    drawing=off \
    script="$PLUGIN_DIR/aerospace.sh" \
  --subscribe aerospace_trigger aerospace_workspace_change

# ===== Separator (Left) =====
sketchybar --add item separator left \
  --set separator \
    icon="" \
    icon.font="Hack Nerd Font:Bold:13.0" \
    icon.color=0xff9ece6a \
    icon.padding_left=4 \
    icon.padding_right=4 \
    label.drawing=off \
    background.drawing=off

# ===== Front App (Left) =====
sketchybar --add item front_app left \
  --set front_app \
    icon.drawing=off \
    label.font="Hack Nerd Font:Bold:12.0" \
    label.color=0xff0f1720 \
    label.padding_left=10 \
    label.padding_right=10 \
    background.drawing=on \
    background.color=0xff9ece6a \
    background.border_color=0xff9ece6a \
    background.border_width=1 \
    background.corner_radius=$ITEM_CORNER_RADIUS \
    background.height=28 \
    script="$PLUGIN_DIR/front_app.sh" \
  --subscribe front_app front_app_switched

# ===== Right Side Items =====
# Each item is its own pill with border
RIGHT_ICON_FONT="Hack Nerd Font:Bold:11.0"
RIGHT_LABEL_FONT="SF Pro:Semibold:13.0"

# -- Clock (rightmost)
sketchybar --add item clock right \
  --set clock \
    update_freq=10 \
    icon.drawing=off \
    label.font="$RIGHT_LABEL_FONT" \
    label.color=$RIGHT_PRIMARY_TEXT \
    label.padding_left=10 \
    script="$PLUGIN_DIR/clock.sh"

# -- Battery
sketchybar --add item battery right \
  --set battery \
    update_freq=120 \
    icon="󰁹" \
    icon.color=$GREEN \
    icon.font="$RIGHT_ICON_FONT" \
    label.font="$RIGHT_LABEL_FONT" \
    label.color=$RIGHT_PRIMARY_TEXT \
    script="$PLUGIN_DIR/battery.sh" \
  --subscribe battery system_woke power_source_change

# -- Do Not Disturb
sketchybar --add item dnd right \
  --set dnd \
    icon="DND" \
    icon.font="$RIGHT_ICON_FONT" \
    icon.color=$RED \
    label.font="$RIGHT_LABEL_FONT" \
    label.color=$RIGHT_PRIMARY_TEXT \
    drawing=off \
    update_freq=5 \
    script="$PLUGIN_DIR/dnd.sh" \
  --subscribe dnd system_woke

-- WiFi
sketchybar --add item wifi right \
  --set wifi \
    icon="WFI" \
    icon.font="Hack Nerd Font:Bold:12.0" \
    icon.color=$BLUE \
    label.font="Hack Nerd Font:Bold:13.0" \
    label.color=$TEXT \
    update_freq=30 \
    script="$PLUGIN_DIR/wifi.sh"

# -- Volume
sketchybar --add item volume right \
  --set volume \
    icon="VOL" \
    icon.font="$RIGHT_ICON_FONT" \
    icon.color=$CYAN \
    label.font="$RIGHT_LABEL_FONT" \
    label.color=$RIGHT_PRIMARY_TEXT \
    script="$PLUGIN_DIR/volume.sh" \
  --subscribe volume volume_change

# -- CPU
sketchybar --add item cpu right \
  --set cpu \
    icon="CPU" \
    icon.font="$RIGHT_ICON_FONT" \
    icon.color=$CYAN \
    label.font="$RIGHT_LABEL_FONT" \
    label.color=$RIGHT_PRIMARY_TEXT \
    update_freq=5 \
    script="$PLUGIN_DIR/cpu.sh"

# -- GPU
sketchybar --add item gpu right \
  --set gpu \
    icon="GPU" \
    icon.font="$RIGHT_ICON_FONT" \
    icon.color=$GREEN \
    label.font="$RIGHT_LABEL_FONT" \
    label.color=$RIGHT_PRIMARY_TEXT \
    update_freq=5 \
    script="$PLUGIN_DIR/gpu.sh"

# -- RAM (leftmost right item)
sketchybar --add item ram right \
  --set ram \
    icon="RAM" \
    icon.font="$RIGHT_ICON_FONT" \
    icon.color=$MAGENTA \
    label.font="$RIGHT_LABEL_FONT" \
    label.color=$RIGHT_PRIMARY_TEXT \
    update_freq=10 \
    script="$PLUGIN_DIR/ram.sh"

# ===== Force all scripts to run =====
sketchybar --update
